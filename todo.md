# 駐車場入出庫システム TODO

## データベース・バックエンド
- [x] 駐車スペーステーブル（10台分）の作成
- [x] 入庫記録テーブルの作成
- [x] 決済履歴テーブルの作成
- [x] 駐車スペース一覧取得API
- [x] 入庫登録API
- [x] 出庫・料金計算API
- [x] 決済処理API（デモ）
- [x] 管理者用：入庫状況一覧API
- [x] 管理者用：決済履歴一覧API

## ユーザー向け画面
- [x] QRコードスキャン画面（カメラまたは手動入力）
- [x] 入庫登録画面
- [x] 出庫・料金確認画面
- [x] デモ決済画面（PayPay/クレジットカード選択）
- [x] 決済完了画面

## 管理者向け画面
- [x] 管理者ダッシュボードレイアウト
- [x] 入庫状況一覧表示
- [x] 決済履歴一覧表示

## QRコード・その他
- [x] 各スペース用QRコード生成機能
- [x] QRコード印刷用ページ
- [x] スカンジナビアンミニマルデザイン適用

## テスト
- [x] バックエンドAPIのVitestテスト

## Stripe Connect連携
- [x] Stripe機能の追加（webdev_add_feature）
- [x] Stripe Connect OAuth認証フロー実装
- [x] 管理者設定画面にStripe接続ボタン追加
- [x] Stripe接続状態の表示（接続済み/未接続）
- [x] 決済処理をStripe実決済に切り替え
- [x] デモ決済モードとの切り替え機能
- [x] Stripe連携のテスト

## Square決済連携
- [x] データベーススキーマにSquare関連フィールド追加
- [x] Square APIヘルパー作成
- [x] Square OAuth認証フロー実装
- [x] 管理者設定画面にSquare接続UI追加
- [x] Square Checkout Session作成API
- [x] Stripe/Square排他選択ロジック

## PayPay API連携
- [x] データベーススキーマにPayPay関連フィールド追加
- [x] PayPay APIヘルパー作成
- [x] 管理者設定画面にPayPay API設定UI追加
- [x] PayPay QRコード決済API実装
- [x] 決済画面にPayPay実決済オプション追加

## 決済設定UI
- [x] クレジットカード決済セクション（Stripe/Square排他選択）
- [x] PayPay決済セクション（独立設定）
- [x] 接続状態の表示
- [x] 決済プロバイダーテスト作成・実行

## バグ修正
- [x] Stripe接続ボタンが画面遷移しない問題を修正
- [x] Square接続ボタンが画面遷移しない問題を修正
- [x] Stripe Connect → 直接決済モードへの変更
- [x] Square APIキー設定方式への変更

## 決済サービスAPIキー直接入力方式
- [x] Stripe APIキー入力フォーム（Secret Key, Publishable Key）
- [x] Square Access Token入力フォーム
- [x] 保存時の接続テスト機能
- [x] 接続成功/失敗の表示

## 料金設定カスタマイズ
- [x] 課金単位設定（10分〜60分プルダウン）
- [x] 料金自由入力
- [x] 料金計算ロジックの動的対応

## マルチテナント対応（オーナー会員機能）
- [x] データベーススキーマ拡張（駐車場テーブル、オーナー紐付け）
- [x] ユーザーロール拡張（user/owner/admin）
- [x] オーナー会員登録機能
- [x] オーナー向けマイページ（自分の駐車場管理）
- [x] オーナー別の決済設定・料金設定
- [x] 駐車場作成・編集機能

## 運営者向け管理機能
- [x] 全オーナー一覧表示
- [x] オーナーアカウント有効化・無効化
- [x] オーナー詳細情報表示
- [x] 全体の利用状況・売上確認
- [x] オーナー承認フロー

## 権限制御
- [x] ロールベースのアクセス制御
- [x] オーナーは自分の駐車場のみアクセス可能
- [x] 運営者は全データにアクセス可能


## 運営管理画面の分離
- [x] ホームページから運営管理リンクを削除
- [x] オーナーページから運営管理へのリンクを非表示に
- [x] 運営管理画面は専用URL（/operator）でのみアクセス可能に


## ホームページ簡素化
- [x] LP説明文・特徴セクション等を削除
- [x] シンプルなログイン画面に変更
- [x] ログイン後オーナーダッシュボードへ遷移


## デモ版作成
- [x] 決済をデモモードに固定（実決済サービス接続なしでも動作）


## ログイン不要のデモ版
- [x] ホームページからログインボタンを削除
- [x] アクセス時に直接オーナーダッシュボードを表示
- [x] 認証チェックを無効化（デモ用）
- [x] ownerProcedureをデモ用ダミーユーザーで動作するように変更


## バグ修正
- [x] 「今すぐ出庫する」ボタン押下時に画面が空白になる問題を修正
- [x] 決済画面で空白になる問題を修正

## 新規バグ報告
- [x] ページリロード後にセッション情報が失われる問題を修正（QRコード読み込み後、再度同じQRを読むと「戻る」ボタンのみ表示される）


## オーナーページの売上ダッシュボード化
- [x] 日ごとの売上グラフを実装
- [x] 月ごとの売上グラフを実装
- [x] 総売上の表示
- [x] 振込先設定機能を実装
- [x] 駐車場設定・管理機能をオーナーページから削除

## 運営者ページの駐車場管理機能
- [x] 運営者ページから各オーナーの駐車場にアクセス可能にする
- [x] 駐車場の料金設定UI（時間単位、金額）
- [x] 駐車スペース数の設定UI
- [x] その他詳細設定

## アクセス制御
- [x] オーナーページから運営者ページへのアクセスを禁止
- [x] 運営者ページから各オーナーページへのアクセスを許可


## 決済システムの一元管理化
- [x] データベーススキーマを拡張（決済方法、手数料、振込スケジュール）
- [x] バックエンドAPIを実装（決済設定の管理）
- [x] 運営者ページに決済設定UIを追加
- [ ] 顧客決済画面を修正（複数決済方法対応）
- [ ] 振込スケジュール表示機能を実装

## 管理者による複数オーナー管理機能
- [x] データベーススキーマを拡張（オーナーのカスタムURL管理）
- [x] バックエンドAPI実装（オーナー追加、カスタムURL的設定）
- [x] 管理者ページを拡張（オーナー一覧、新規追加、リンク管理）
- [x] オーナーページを個別化（カスタムURLでアクセス）
- [x] テスト・チェックポイント保存・デリバリーーのページにアクセス可能にする


## operatorページのオーナー管理機能拡張
- [x] operatorページにオーナー管理セクションを追加
- [x] オーナー追加ボタンと各オーナーページへのアクセスリンクを実装
- [x] オーナー追加フォームの管理UI実装


## operatorページのオーナー詳細設定機能
- [x] オーナー追加後にURLを表示・コピー機能を実装
- [ ] operatorページにオーナー詳細設定画面を追加（駐車台数、料金設定、最大駐車料金）
- [ ] バックエンドAPIで料金設定の保存・更新を実装
- [ ] 時間毎の料金設定UI（複数設定対応）を実装


## operatorページの駐車場設定機能（新規）
- [x] operatorページでオーナーの駐車場一覧を表示
- [x] 駐車場をクリックして詳細設定画面を開く
- [x] 駐車台数（スペース数）の編集フォーム
- [x] 時間毎の料金設定（複数設定対応）
- [x] 最大駐車料金（1日の上限）の設定
- [x] 設定の保存・更新API
- [x] 設定変更の成功・エラーメッセージ表示


## operatorページのオーナー詳細画面（新規）
- [x] オーナーカードをクリック可能にする
- [x] オーナー詳細画面ダイアログを実装
- [x] そのオーナーの全駐車場一覧を表示
- [ ] 各駐車場の駐車台数、料金設定を表示
- [ ] 駐車場をクリックして設定を編集できるようにする
- [ ] オーナー詳細画面で駐車場の追加機能を実装

## operatorページから駐車場を作成する機能（新規）
- [x] オーナー詳細ダイアログに「駐車場を追加」ボタンを追加
- [x] 駐車場追加フォームを実装
- [x] バックエンドAPIで駐車場を作成し、オーナーに関連付ける
- [x] 駐車場作成後、一覧に反映される


## 時間帯ごとの最大料金設定機能（新規）
- [x] データベーススキーマを拡張（時間帯ごとの最大料金テーブル）
- [x] バックエンドAPI実装（時間帯ごとの最大料金の保存・取得・更新）
- [ ] 料金計算ロジック実装（複数の時間帯を跨ぐ場合の計算）
- [ ] operatorページのUI実装（時間帯ごとの最大料金設定フォーム）
- [ ] 駐車場詳細設定ダイアログに時間帯ごとの最大料金設定を追加
- [ ] テスト・検証

## 料金計算単位の自由入力機能（新規）
- [x] ParkingLotDetailDialogの料金計算単位をドロップダウンから自由入力に変更
- [x] AddParkingLotDialogの料金計算単位をドロップダウンから自由入力に変更
- [x] 10分単位の入力制限を実装
- [x] 変更内容がデータベースに保存される


## 昬夜の時間帯ごとの最大料金設定機能（新規）
- [x] operatorページに昼夜の時間帯ごとの最大料金設定UIを実装
- [x] 時間をプルダウン（0～23時）で選択可能にする
- [x] 最大料金を100円一位プルダウンで選択可能にする
- [x] 昼夜の2項目を保存・更新できるようにする
- [x] テスト・検証

## 複数時間帯を跨ぐ料金計算ロジック（新規）
- [x] 入庫時点から24時間以内の駐車に対して時間帯ごとの最大料金を適用
- [x] 最大料金は「その時間帯全体での最大料金」として適用
- [x] 複数の時間帯を跨ぐ場合の料金計算ロジック実装
- [x] テスト・検証

## 1日最大料金のチェックボックス機能（新規）
- [x] データベーススキーマに`maxDailyAmountEnabled`フラグを追加
- [x] AddParkingLotDialogにチェックボックスを追加
- [x] ParkingLotDetailDialogにチェックボックスを追加
- [x] 料金計算ロジックを修正（チェックボックスがOFFの場合は1日最大料金を無視）
- [x] テスト・検証

## React Hooksエラー修正（新規）
- [x] AddParkingLotDialogの`useMutation`フックをイベントハンドラー内で呼び出していた問題を修正
- [x] ParkingLotDetailDialogの`trpc.useUtils()`をコールバック内で呼び出していた問題を修正

## オーナーと駐車場の削除機能（新規）
- [x] バックエンドAPI実装（駐車場削除）
- [ ] UIコンポーネント修正（削除ボタン追加） - 型推論の問題を解決後に実装
- [ ] テスト・検証
## QRコード生成・表示機能（新規）

- [x] QRコード生成ライブラリ（qrcode.react）をインストール
- [x] 駐車場のカスタムURLをQRコード化する機能を実装
- [x] 運営者ダッシュボードにQRコード表示機能を追加
- [x] 各駐車場ごとのQRコードを表示・ダウンロード可能にする
- [x] テスト・検証

## オーナーページ駐車場設定表示機能（新規）
- [x] owner.getParkingLotInfoプロシージャを実装
- [x] OwnerDashboardにParkingLotSettingsCardコンポーネントを追加
- [x] 駐車台数、料金設定、最大駐車料金を読み取り専用で表示
- [x] 時間帯ごとの最大料金設定も表示
- [ ] テスト・検証

## 時間帯ごとの最大料金設定の有効/無効化機能（新規）
- [x] operatorページの駐車場設定で時間帯ごとの最大料金設定をチェックボックスで有効/無効化
- [x] オーナーページの設定画面に時間帯ごとの最大料金設定を表示
- [x] テスト・検証

## 時間帯ごとの最大料金設定チェックボックス表示問題（修正中）
- [x] operatorページで時間帯ごとの最大料金設定チェックボックスが表示されていることを確認
- [x] オーナーページで時間帯ごとの最大料金設定内容がテキストとして表示されていることを確認

## 駐車場編集時の時間帯ごとの最大料金設定チェックボックス表示問題（修正完了）
- [x] ParkingLotDetailDialogに「時間帯ごとの最大料金設定を有効にする」チェックボックスを追加
- [x] 既に追加した駐車場の設定を編集する際にチェックボックスが表示されることを確認
- [x] テスト・検証

## 昔間と夜間それぞれのチェックボックス追加（修正完了）
- [x] AddParkingLotDialogに昔間と夜間ごとのチェックボックスを追加
- [x] ParkingLotDetailDialogに昔間と夜間ごとのチェックボックスを追加
- [x] timePeriodsに昔間と夜間の有効/無効フラグを追加
- [x] テスト・検証

## オーナーページ複数駐車場対応（完了）
- [x] owner.getParkingLotsプロシージャを実装
- [x] OwnerDashboardの設定画面を複数駐車場対応に修正
- [x] 各駐車場ごとに時間帯ごとの最大料金設定を表示
- [x] テスト・検証

## オーナーページ駐車場設定表示問題（修正完了）
- [x] getParkingLotsプロシージャが正しく動作していることを確認
- [x] getMaxPricingPeriodsByLot関数を使用して修正
- [x] ParkingLotSettingsCardが正しくデータを取得・表示していることを確認
- [x] 問題を修正してテスト完了

## オーナーページ駐車場表示問題・オペレーターページ削除機能（修正完了）
- [x] OperatorDashboardコンポーネントを作成
- [x] App.tsxに/operatorルートを追加
- [x] owner.getParkingLotsプロシージャにエラーハンドリングを追加
- [x] ParkingLotSettingsCardコンポーネントにエラー表示機能を追加
- [x] オーナーページで駐車場が正しく表示されることを確認
- [x] オペレーターページで全駐車場が表示されることを確認
- [x] 削除ボタンが正常に機能することを確認
- [x] テスト・検証完了


## オペレーターダッシュボードの改善（新規）
- [x] オーナー選択時に該当オーナーの駐車場のみ表示するフィルタリング機能を実装
- [x] オーナー選択時にオーナーの売上情報を表示する機能を実装
- [x] テスト・検証
- [x] オーナー追加機能が実装されているか確認
- [x] オーナー追加機能が削除されていないか確認
- [x] オーナー追加機能を復旧


## 駐車場削除機能のReact Hooksエラー修正（新規）
- [x] 削除ボタンのHooks呼び出しエラーを特定
- [x] React Hooksルール違反を修正
- [x] 削除機能をテストして確認


## 削除ボタン内のReact Hooksエラー修正（完了）
- [x] 削除ボタンのイベントハンドラー内のHooks呼び出しエラーを特定
- [x] Hooksルール違反を修正（try-catchで囲む）
- [x] 削除機能をテストして確認


## オペレーター画面の駐車場詳細編集機能の問題（完了）
- [x] オーナー選択後に駐車場を選択しても詳細編集ができない問題を調査
- [x] 原因を特定して修正（駐車詳細編集ダイアログを実装）
- [x] テスト・検証
## オーナーマイページの駐車場フィルタリング問題（完了）

- [x] /owner/oikawa等のオーナーページで、そのオーナー以外の駐車場が表示される問題を調査
- [x] 売上情報も混ざっていないか確認
- [x] 原因を特定して修正（getParkingLotsByCustomUrlプロシージャーを追加）
- [x] テスト・検証


## 駐車場の完全削除機能（完了）
- [x] バックエンドの削除ロジックを論理削除から物理削除に変更
- [x] オーナーマイページの設定画面から削除した駐車場を非表示にする（activeステータスのみ表示）
- [x] オペレーターページで完全削除ができるようにする
- [x] テスト・検証


## オペレーターページの駐車場追加ボタン復元（完了）
- [x] オーナー選択後に駐車場追加ボタンが表示されない問題を調査
- [x] 駐車場追加ボタンを復元
- [x] テスト・検証

## オーナー月別売上表示機能（完了）
- [x] バックエンドに月別売上取得プロシージャを追加（getMonthlySalesByYearMonth, getAvailableYearMonths）
- [x] フロントエンドにプルダウンで年月選択UIを追加
- [x] 選択した月のトータル売上を表示
- [x] テスト・検証


## 失われた機能の復元（完了）
- [x] チェックボックス機能の復元（1日最大料金の有効/無効、時間帯ごとの最大料金設定の有効/無効）
- [x] 昼夜の最大料金機能の復元（時間帯ごとの最大料金設定）
- [x] テスト・検証


## オペレーターページのオーナー売上・振込先情報表示（完了）
- [x] オペレーターページのオーナー選択画面に月別売上表示を追加
- [x] オペレーターページのオーナー選択画面に振込先情報を表示
- [x] バックエンドに振込先情報取得プロシージャを追加（管理者用）
- [x] テスト・検証


## 昼夜個別チェックボックス機能の復元（完了）
- [x] オペレーターページの駐車場設定で昼と夜それぞれの最大料金を個別にチェックボックスで有効/無効化できる機能を復元
- [x] テスト・検証


## 駐車場追加エラー修正（完了）
- [x] admin.createParkingLotForOwnerプロシージャが見つからないエラーを修正（trpc.operator.createParkingLotForOwnerに変更）
- [x] テスト・検証


## 次のステップ実装（完了）
- [x] 既存駐車場の編集ダイアログ（ParkingLotDetailDialog）に時間帯ごとの最大料金設定表示を追加
- [x] TypeScriptエラーの解消（parkingRouterにgetParkingLotsByCustomUrlを追加）
- [x] 決済画面の複数決済方法対応（デモモードで動作確認済み）
- [x] テスト・検証


## 駐車場追加エラー修正と編集機能追加（完了）
- [x] 駐車場追加時の時間帯設定エラーを修正（max_pricing_periodsテーブルが存在しなかったため作成）
- [x] 既存駐車場の編集機能を実装（料金設定、台数、最大料金、時間帯設定を編集可能に）
- [x] テスト・検証


## オペレーターページQRコード表示機能（完了）
- [x] 駐車場ごとの駐車スペース一覧を取得するAPIを確認・実装
- [x] 駐車スペースごとの固定QRコード生成ロジックを実装
- [x] オペレーターページの駐車場詳細ダイアログにQRコード表示セクションを追加
- [x] 駐車台数分のQRコードを表示（10台なら10個）
- [x] QRコードの一括ダウンロード機能を追加
- [x] テスト・検証


## QRコード表示改善と入庫状況確認機能（完了）
- [x] QRコードの表示サイズを小さく調整（PCで見やすく）
- [x] QRコードのレイアウトを整える（6列グリッドで整然と表示）
- [x] オペレーターページに入庫状況確認機能を追加（使用中/空きバッジ表示）
- [x] オーナーページに入庫状況確認機能を追加（使用中/空きバッジ表示）
- [x] テスト・検証


## QRコード高解像度化（完了）
- [x] QRコード生成の解像度設定を調査
- [x] 表示サイズは小さく（60x60）、ダウンロード時は高解像度（480x480）に設定
- [x] 印刷時に大きく拡大しても鮮明に表示されるようにする（8倍スケールでダウンロード）
- [x] テスト・検証


## 決済完了画面のユーザーフロー修正（完了）
- [x] 決済完了画面から「ホームへ戻る」ボタンを削除
- [x] 「決済が完了しました。5分以内に出庫してください。」メッセージを表示
- [x] ヘッダーの「戻る」ボタンも決済完了画面では非表示に
- [x] 入庫完了画面からも「ホームへ戻る」ボタンを削除
- [x] テスト・検証


## QRスキャン画面の問題修正（完了）
- [x] カメラでQR読み込み時の「戻る」ボタンを非表示に（全画面で非表示）
- [x] 入庫時の「page is currently unavailable」エラーを修正（動作確認済み）
- [x] 使用中QRを読み込んだ時の出庫フローを修正（セッショントークンを取得して出庫確認画面へ遷移）
- [x] テスト・検証


## 複数決済サービス連携（完了）
- [x] PayPay・Stripeの本番設定ガイド作成
- [x] LINE Pay API連携の実装（APIヘルパー作成）
- [x] 楽天ペイAPI連携の実装（APIヘルパー作成）
- [x] 決済画面の複数決済方法対応（PayPay/クレジットカード/LINE Pay/楽天ペイ/Apple Pay）
- [x] Apple Pay対応（Stripe経由）

## 振込管理機能の強化（完了）
- [x] 振込予定日の表示（毎月15日）
- [x] 振込予定額の表示（前月売上集計）
- [x] オーナーマイページに振込スケジュール表示
- [x] 前回振込実績の表示


## 決済設定のオペレーター一元管理化（完了）
- [x] データベーススキーマ変更（決済設定をオペレーター管理のグローバル設定に変更）
- [x] オペレーター用決済設定画面を修正（オーナー/駐車場選択を削除、グローバル設定に変更）
- [x] 決済処理で共通の決済設定を使用するように修正
- [x] オーナーごとの売上集計機能を実装（決済履歴にオーナーIDを紐付け）
- [x] オペレーターページでオーナー別売上レポートを表示
- [x] テスト・検証


## 顧客決済画面へのグローバル決済設定反映
- [x] グローバル決済設定を取得する公開APIを追加
- [x] 顧客決済画面でグローバル決済設定を取得
- [x] 有効な決済方法のみを決済画面に表示
- [x] 動作確認とテスト


## バグ修正: 決済設定タブのAPI連携項目復元
- [x] PaymentSettingsTabコンポーネントにAPIキー、シークレットキー、マーチャントID入力欄を復元
- [x] 動作確認


## オーナー別売上データCSVエクスポート機能
- [x] CSVエクスポートAPIの実装（オーナー別、期間指定対応）
- [x] オペレーターダッシュボードにエクスポートUIを追加
- [x] オペレーター画面に各オーナー管理ページへのリンクボタンを追加
- [x] 動作確認とテスト


## 本番サーバーデプロイ対応
- [x] オペレーターページを認証不要にする（デモ版対応）
- [ ] GitHubにプッシュして本番サーバーで再デプロイ

## オペレーターページ機能復旧（バグ修正）
- [ ] 各オーナーの総売上表示機能を確認・復旧
- [ ] 月別売上表示機能（年月プルダウン選択）を確認・復旧
- [ ] 駐車場クリック時の設定変更機能を確認・復旧
- [ ] 駐車場クリック時のQRコード確認機能を確認・復旧

## オーナーページプロフィール更新問題の修正
- [x] オーナーページでプロフィール変更時に正しいオーナーのデータが更新されるように修正
- [x] カスタムURLに基づいてオーナーを特定するロジックを実装

## オーナー追加API修正
- [x] admin.addOwnerをoperator.addOwnerに修正
